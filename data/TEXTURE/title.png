/*****************************************************************************
bullet.cpp
Aythor	: ã–ì@ 
Data	: 2016_07_08
=============================================================================
Updata

*****************************************************************************/
//////////////////////////////////////////////////////////////////////////////
//ƒwƒbƒ_[ƒtƒ@ƒCƒ‹ƒCƒ“ƒNƒ‹[ƒh
//////////////////////////////////////////////////////////////////////////////
#include "bullet.h"
#include "input.h"
#include "main.h"

//////////////////////////////////////////////////////////////////////////////
//’è”’è‹`
//////////////////////////////////////////////////////////////////////////////
#define BULLET_POS_X	(0)		//ƒ|ƒŠƒSƒ“‚Ì•\¦ˆÊ’uX
#define BULLET_POS_Y	(0)		//ƒ|ƒŠƒSƒ“‚Ì•\¦ˆÊ’uY

#define BULLET_WIDTH	(200)	//ƒ|ƒŠƒSƒ“‚Ì•
#define BULLET_HEIGHT	(52)	//ƒ|ƒŠƒSƒ“‚Ì‚‚³

#define BULLET_SPEED	(20.f)	//’e‚Ì‘¬‚³

#define MAX_BULLET		(255)	//’e‚ÌÅ‘å”

#define TEXTURE_WIDTH	(1.0f)	//ƒeƒNƒXƒ`ƒƒˆê‚Â•ª‚Ì•
#define TEXTURE_HEIGHT	(1.0f)	//ƒeƒNƒXƒ`ƒƒˆê‚Â•ª‚Ì‚‚³

//////////////////////////////////////////////////////////////////////////////
//\‘¢‘Ì’è‹`
//////////////////////////////////////////////////////////////////////////////
BULLET bullet[MAX_BULLET];					//BulletŠeíİ’è

//////////////////////////////////////////////////////////////////////////////
//ƒvƒƒgƒ^ƒCƒvéŒ¾
//////////////////////////////////////////////////////////////////////////////
HRESULT makeVertexBullet ( LPDIRECT3DDEVICE9 pDevice );
void setVertexBullet ( int bulletIndex );

//////////////////////////////////////////////////////////////////////////////
//ƒOƒ[ƒoƒ‹•Ï”
//////////////////////////////////////////////////////////////////////////////
LPDIRECT3DTEXTURE9	g_pTextureBullet = NULL;	//ƒeƒNƒXƒ`ƒƒƒCƒ“ƒ^[ƒtƒFƒCƒX
LPDIRECT3DVERTEXBUFFER9 g_pVtxBufferBullet = NULL;	//’¸“_ƒoƒbƒtƒ@ŠÇ—ƒCƒ“ƒ^[ƒtƒFƒCƒX

char *g_blletTexAddress[] =
{
	"data/TEXTURE/bullet001.png",
	" "
};

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: initBullet
//•Ô‚è’l	: 
//à–¾		: ƒ|ƒŠƒSƒ“‰Šú‰»
//////////////////////////////////////////////////////////////////////////////
void initBullet ( void )
{
	//•Ï”éŒ¾
	LPDIRECT3DDEVICE9 pDevice = getDevice();	//ƒfƒoƒCƒXƒ|ƒCƒ“ƒ^æ“¾
	int		i;	//loop—p

	//ƒfƒoƒCƒXæ“¾
	makeVertexBullet(pDevice);

	//ƒ|ƒŠƒSƒ“‰Šú‰»
	for(i = 0; i < MAX_BULLET; i++)
	{
		initPolygon(&bullet[i].conf);
	}

	//\‘¢‘Ìİ’è
	for(i = 0; i < MAX_BULLET; i++)
	{
		bullet[i].conf.pos			= D3DXVECTOR3(0.0f, 0.0f, 0.0f);
		bullet[i].conf.width		= D3DXVECTOR3(BULLET_WIDTH, BULLET_HEIGHT, 0.0f);
		bullet[i].conf.tex			= D3DXVECTOR2(0.0f, 0.0f);
		bullet[i].conf.texWidth		= D3DXVECTOR2(TEXTURE_WIDTH, TEXTURE_HEIGHT);
		bullet[i].use				= false;
	}

	//ƒeƒNƒXƒ`ƒƒ‚Ì“Ç‚İ‚İ
	if(FAILED(D3DXCreateTextureFromFile(pDevice, g_blletTexAddress[0], &g_pTextureBullet)))
	{
		MessageBox(NULL, "ƒGƒ‰[", "ƒGƒ‰[", MB_OK);
	}
}

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: uninitBULLET
//•Ô‚è’l	: 
//à–¾		: ƒ|ƒŠƒSƒ“I—¹
//////////////////////////////////////////////////////////////////////////////
void uninitBullet ( void )
{
	//ƒeƒNƒXƒ`ƒƒƒCƒ“ƒ^[ƒtƒFƒCƒX‚Ì‰ğ•ú
	if(g_pTextureBullet != NULL)
	{
		g_pTextureBullet->Release();
		g_pTextureBullet = NULL;
	}

	//’¸“_ƒoƒbƒtƒ@ŠÇ—‚Ì‰ğ•ú
	if(g_pVtxBufferBullet != NULL)
	{
		g_pVtxBufferBullet->Release();
		g_pVtxBufferBullet = NULL;
	}
}

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: updateBullet
//•Ô‚è’l	: 
//à–¾		: ƒ|ƒŠƒSƒ“XV
///////////////////////////////////////////////////////////////////////////////
void updateBullet ( void )
{
	//•Ï”éŒ¾
	int		i;		//loop—p

	for(i = 0; i < MAX_BULLET; i++)
	{
		if(bullet[i].use == true)
		{
			setVertexBullet(i);
			bullet[i].conf.pos.x += BULLET_SPEED;
			bullet[i].conf.width.x = bullet[i].conf.pos.x + BULLET_WIDTH;

			if(bullet[i].conf.pos.x > SCREEN_WIDTH + BULLET_WIDTH)
			{
				bullet[i].conf.pos = D3DXVECTOR3(0.f, 0.f, 0.f);
				bullet[i].conf.width = D3DXVECTOR3(0.f, 0.f, 0.f);
				bullet[i].use = false;
			}
		}
	}
}

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: drawBullet
//•Ô‚è’l	: 
//à–¾		: ƒ|ƒŠƒSƒ“•`Ê
//////////////////////////////////////////////////////////////////////////////
void drawBullet ( void )
{
	//•Ï”éŒ¾
	LPDIRECT3DDEVICE9 pDevice = getDevice();

	//ƒXƒgƒŠ[ƒ€ì¬
	pDevice->SetStreamSource(0, g_pVtxBufferBullet, 0, sizeof(VERTEX2D));

	//’¸“_ƒtƒH[ƒ}ƒbƒg‚Ìİ’è
	pDevice->SetFVF(FVF_VERTEX_2D);

	//ƒeƒNƒXƒ`ƒƒ‚Ìİ’è
	pDevice->SetTexture(0,g_pTextureBullet);

	//ƒ|ƒŠƒSƒ“‚Ì•`‰æ
	pDevice->DrawPrimitive
		(
		D3DPT_TRIANGLESTRIP,	//ƒ|ƒŠƒSƒ“‚Ìí—Ş
		0,						//ƒIƒtƒZƒbƒg(’¸“_”)
		NUM_POLYGON * MAX_BULLET				//ƒ|ƒŠƒSƒ“‚Ì”
		);
}

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: makeVertexBullet
//•Ô‚è’l	: 
//à–¾		: ’¸“_ì¬
//////////////////////////////////////////////////////////////////////////////
HRESULT makeVertexBullet ( LPDIRECT3DDEVICE9 pDevice )
{
	//•Ï”éŒ¾
	VERTEX2D	*pVtx = NULL;;		//‰¼‘zƒAƒhƒŒƒX—pƒ|ƒCƒ“ƒ^
	int			i;					//‰½‰ñ–Ú‚ÌpVtx‚©

	//’¸“_ƒoƒbƒtƒ@‚Ìİ’è
	if(FAILED(pDevice->CreateVertexBuffer
			(
			sizeof(VERTEX2D) * NUM_VERTEX * MAX_BULLET,	//’¸“_ƒoƒbƒtƒ@ƒTƒCƒY
			D3DUSAGE_WRITEONLY,					//’¸“_ƒoƒbƒtƒ@‚Ìg—p•û–@
			FVF_VERTEX_2D,						//
			D3DPOOL_MANAGED,					//ƒƒ‚ƒŠŠÇ—•û–@
			&g_pVtxBufferBullet,				//’¸“_ƒoƒbƒtƒ@ŠÇ—ƒCƒ“ƒ^[ƒtƒFƒCƒX
			NULL
			)
		))
		
	{
		return E_FAIL;
	}

	//’¸“_ƒoƒbƒtƒ@‚ğƒƒbƒN‚µ‚Ä‰¼‘zƒAƒhƒŒƒX‚ğæ“¾
	g_pVtxBufferBullet->Lock(0, 0, (void**)&pVtx, 0);

	for(i = 0; i < MAX_BULLET; i++)
	{
		//’¸“_À•W‚Ìİ’è(2DÀ•WE‰E‰ñ‚è)
		pVtx[0].pos = D3DXVECTOR3(0.f, 0.f, 0.0f);
		pVtx[1].pos = D3DXVECTOR3(0.f, 0.f, 0.0f);
		pVtx[2].pos = D3DXVECTOR3(0.f, 0.f, 0.0f);
		pVtx[3].pos = D3DXVECTOR3(0.f, 0.f, 0.0f);

		//rhw‚Ìİ’è(•K‚¸1.0f)
		pVtx[0].rhw = 1.0f;
		pVtx[1].rhw = 1.0f;
		pVtx[2].rhw = 1.0f;
		pVtx[3].rhw = 1.0f;

		//’¸“_ƒJƒ‰[‚Ìİ’è(0~155‚Ì®”’l)
		pVtx[0].color = D3DCOLOR_RGBA(255, 255, 255, 255);
		pVtx[1].color = D3DCOLOR_RGBA(255, 255, 255, 255);
		pVtx[2].color = D3DCOLOR_RGBA(255, 255, 255, 255);
		pVtx[3].color = D3DCOLOR_RGBA(255, 255, 255, 255);
	
		//ƒeƒNƒXƒ`ƒƒ’¸“_À•W‚Ìİ’è(0~1)
		pVtx[0].tex = D3DXVECTOR2(0.0f, 0.0f);
		pVtx[1].tex = D3DXVECTOR2(1.0f, 0.0f);
		pVtx[2].tex = D3DXVECTOR2(0.0f, 1.0f);
		pVtx[3].tex = D3DXVECTOR2(1.0f, 1.0f);

		//ƒ|ƒCƒ“ƒ^ˆÚ“®
		pVtx += NUM_VERTEX;
	}

	//„‚Ì‚±‚±‚ëƒA[ƒ“ƒƒbƒNô
	g_pVtxBufferBullet->Unlock();

	return S_OK;
}

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: setVertexBullet
//•Ô‚è’l	: 
//à–¾		: ’¸“_À•Wİ’è
//////////////////////////////////////////////////////////////////////////////
void setVertexBullet ( int bulletIndex )
   {
	//•Ï”éŒ¾
	VERTEX2D	*pVtx = NULL;;		//‰¼‘zƒAƒhƒŒƒX—pƒ|ƒCƒ“ƒ^

	//’¸“_ƒoƒbƒtƒ@‚ğƒƒbƒN‚µ‚Ä‰¼‘zƒAƒhƒŒƒX‚ğæ“¾
	g_pVtxBufferBullet->Lock(0, 0, (void**)&pVtx, 0);

	pVtx += bulletIndex * NUM_VERTEX;

	//ƒ|ƒŠƒSƒ“‚ÌÀ•Wİ’è
	pVtx[0].pos = D3DXVECTOR3(bullet[bulletIndex].conf.pos.x, bullet[bulletIndex].conf.pos.y, 0.0f);
	pVtx[1].pos = D3DXVECTOR3(bullet[bulletIndex].conf.width.x, bullet[bulletIndex].conf.pos.y, 0.0f);
	pVtx[2].pos = D3DXVECTOR3(bullet[bulletIndex].conf.pos.x, bullet[bulletIndex].conf.width.y, 0.0f);
	pVtx[3].pos = D3DXVECTOR3(bullet[bulletIndex].conf.width.x, bullet[bulletIndex].conf.width.y, 0.0f);

	//ƒeƒNƒXƒ`ƒƒ’¸“_À•W‚Ìİ’è(0~1)
	pVtx[0].tex = D3DXVECTOR2(bullet[bulletIndex].conf.tex.x, bullet[bulletIndex].conf.tex.y);
	pVtx[1].tex = D3DXVECTOR2(bullet[bulletIndex].conf.texWidth.x, bullet[bulletIndex].conf.tex.y);
	pVtx[2].tex = D3DXVECTOR2(bullet[bulletIndex].conf.tex.x, bullet[bulletIndex].conf.texWidth.y);
	pVtx[3].tex = D3DXVECTOR2(bullet[bulletIndex].conf.texWidth.x, bullet[bulletIndex].conf.texWidth.y);

	//ƒoƒbƒtƒ@ƒAƒ“ƒƒbƒN
	g_pVtxBufferBullet->Unlock();
}

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: setMousePos
//•Ô‚è’l	: 
//à–¾		: ƒ}ƒEƒXÀ•Wæ“¾
//////////////////////////////////////////////////////////////////////////////
POINT setMousePos (POINT mousePos)
{
	return mousePos;
}

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: setBulletUse
//•Ô‚è’l	: 
//à–¾		: ’e‚Ìg—pî•ñİ’è
//////////////////////////////////////////////////////////////////////////////
void setBulletUse (bool setUse)
{
	//•Ï”éŒ¾
	int		i;		//loop—p

	for(i = 0; i < MAX_BULLET; i++)
	{
		if(bullet[i].use == false)
		{
			bullet[i].use = setUse;

			break;
		}
	}
}

//////////////////////////////////////////////////////////////////////////////
//ŠÖ”–¼	: setBulletPos
//•Ô‚è’l	: 
//à–¾		: ’e‚ÌÀ•Wİ’è
//////////////////////////////////////////////////////////////////////////////
void setBulletPos ( D3DXVECTOR3 pos )
{
	//•Ï”éŒ¾
	int		i;		//loop—p

	for(i = 0; i < MAX_BULLET; i++)
	{
		if(bullet[i].use == false)
		{
			//ˆÊ’uî•ñæ“¾
			bullet[i].conf.pos = pos;

			bullet[i].conf.width = D3DXVECTOR3(
				bullet[i].conf.pos.x + BULLET_WIDTH,
				bullet[i].conf.pos.y + BULLET_HEIGHT,
				0.f);

			bullet[i].use = true;

			break;
		}
	}
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    INDX( 	 $ŸI0            (   h  è        .                        p \          s-ªŞùıÑÀw.úıÑõõİüıÑs-ªŞùıÑ                        b u l l e t 0 0 1 . p n g          p Z          s-ªŞùıÑÀw.úıÑõõİüıÑs-ªŞùıÑ                        B U L L E T ~ 1 . P N G            h T          ím¯ŞùıÑğÏw.úıÑõõİüıÑím¯ŞùıÑ                        	e a r t h . p n g         	 ` P          }µŞùıÑ¥1x.úıÑõõİüıÑ}µŞùıÑ                        e n d . p n g      p Z          Ë ·ŞùıÑÖx.úıÑ	ŞüıÑË ·ŞùıÑ                        e n e m y 0 0 1 . p n g            p \          û¸ŞùıÑõx.úıÑ	ŞüıÑû¸ŞùıÑ                        g a m e B G 0 0 1 . j p g          p Z          û¸ŞùıÑõx.úıÑ	ŞüıÑû¸ŞùıÑ                        G A M E B G ~ 1 . J P G            h T          ¯ÌºŞùıÑXjy.úıÑ	ŞüıÑ¯ÌºŞùıÑ                        	s c o r e . p n g          h T          ´€»ŞùıÑ ëàF¶Ñ	ŞüıÑ´€»ŞùıÑ `      Z     &       	T h u m b s  d b          h T          †)¿ŞùıÑšßy.úıÑ	ŞüıÑ†)¿ŞùıÑ                        	t i t l e . p n g                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           